<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogiMóveis - Marketplace de Grandes Entregas</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #2563eb;
            --dark: #0f172a;
            --light: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--light); color: var(--dark); padding-bottom: 50px; }

        /* HEADER */
        header { background: var(--surface); padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; }
        .logo { font-weight: 900; font-size: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
        .nav-actions { display: flex; gap: 1rem; }

        /* CONTAINERS */
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 5%; }
        .section { display: none; }
        .section.active { display: block; animation: fadeUp 0.4s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS & GRIDS */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .card { background: var(--surface); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border); transition: 0.2s; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .card img { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; background: #eee; margin-bottom: 1rem; }

        /* BUTTONS & INPUTS */
        .btn { padding: 0.8rem 1.5rem; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; justify-content: center; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--dark); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }

        input, select { width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1rem; background: #fdfdfd; }
        label { display: block; margin-bottom: 0.4rem; font-size: 0.9rem; font-weight: 600; color: #64748b; }

        /* AUTH SELECTION CARDS */
        .role-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .role-card { cursor: pointer; border: 2px solid var(--border); padding: 1.5rem; border-radius: 12px; text-align: center; }
        .role-card.selected { border-color: var(--primary); background: #eff6ff; }
        .role-icon { font-size: 2rem; color: var(--primary); margin-bottom: 0.5rem; display: block; }

        /* CAMERA MOCK */
        #camera-preview { width: 100%; height: 200px; background: #000; border-radius: 8px; display: none; object-fit: cover;}
        .verified-badge { color: green; display: flex; align-items: center; gap: 0.5rem; font-weight: bold; display: none; margin-bottom: 1rem;}

        /* UTILS */
        .hidden { display: none !important; }
        .hero { text-align: center; margin-bottom: 3rem; }
        .hero h1 { font-size: 2.5rem; margin-bottom: 0.5rem; letter-spacing: -1px; }
        .hero p { color: #64748b; font-size: 1.1rem; }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; width: 90%; max-width: 500px; padding: 2rem; border-radius: 16px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

    <header>
        <div class="logo"><i class="ri-truck-fill"></i> LogiMóveis</div>
        <div class="nav-actions" id="nav-actions">
            <button class="btn btn-primary" onclick="openAuthModal()">Entrar / Cadastrar</button>
        </div>
    </header>

    <div id="home-section" class="section active container">
        <div class="hero">
            <h1>Transporte de Cargas Pesadas & Montagem</h1>
            <p>Conectando lojas, entregadores e montadores em um só lugar.</p>
        </div>
        
        <h3 style="margin-bottom: 1rem;">Vitrine de Ofertas</h3>
        <div id="public-catalog" class="grid">
            <p>Carregando ofertas...</p>
        </div>
    </div>

    <div id="dashboard-section" class="section container">
        <div id="dashboard-content"></div>
    </div>

    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                <h2 id="auth-title">Acessar Conta</h2>
                <button onclick="closeAuthModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>

            <div id="login-form">
                <label>Email</label>
                <input type="email" id="login-email" placeholder="seu@email.com">
                <label>Senha</label>
                <input type="password" id="login-pass" placeholder="******">
                <button class="btn btn-primary" style="width:100%" onclick="login()">Entrar</button>
                <p style="text-align:center; margin-top:1rem; cursor:pointer; color:var(--primary)" onclick="showRoleSelection()">Não tem conta? Cadastre-se</p>
            </div>

            <div id="role-selection" class="hidden">
                <p style="margin-bottom:1rem; text-align:center;">Quem é você?</p>
                <div class="role-grid">
                    <div class="role-card" onclick="selectRole('cliente')">
                        <i class="ri-user-smile-line role-icon"></i> Cliente
                    </div>
                    <div class="role-card" onclick="selectRole('loja_admin')">
                        <i class="ri-store-2-line role-icon"></i> Loja
                    </div>
                    <div class="role-card" onclick="selectRole('motorista')">
                        <i class="ri-truck-line role-icon"></i> Motorista
                    </div>
                    <div class="role-card" onclick="selectRole('montador')">
                        <i class="ri-hammer-line role-icon"></i> Montador
                    </div>
                </div>
                <button class="btn btn-outline" style="width:100%" onclick="backToLogin()">Voltar ao Login</button>
            </div>

            <div id="register-form" class="hidden">
                <h3 id="reg-role-title" style="margin-bottom:1rem;">Cadastro</h3>
                
                <label>Email</label>
                <input type="email" id="reg-email">
                <label>Senha</label>
                <input type="password" id="reg-pass">
                
                <div id="dynamic-fields"></div>

                <button class="btn btn-primary" style="width:100%" onclick="registerUser()">Finalizar Cadastro</button>
                <button class="btn btn-outline" style="width:100%; margin-top:0.5rem" onclick="showRoleSelection()">Voltar</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURAÇÃO SUPABASE (Global) ---
        const supabaseUrl = 'SUA_URL_SUPABASE'; // Coloque sua URL
        const supabaseKey = 'SUA_KEY_ANON'; // Coloque sua KEY
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // --- 2. ESTADO GLOBAL ---
        let selectedRole = null;
        let currentUser = null;

        // --- 3. INICIALIZAÇÃO ---
        async function init() {
            // Verifica sessão
            const { data } = await supabase.auth.getSession();
            if (data.session) {
                currentUser = data.session.user;
                updateHeader(true);
                // Se já estiver logado, redireciona para dashboard, mas permite ver home
            } else {
                updateHeader(false);
            }
            // Sempre carrega o catálogo público
            loadPublicCatalog();
        }

        // --- 4. LÓGICA DE UI (Catálogo Público) ---
        async function loadPublicCatalog() {
            const { data: products, error } = await supabase
                .from('products')
                .select('*, stores(nome_loja, cidade)');
            
            if (error) {
                console.error(error);
                document.getElementById('public-catalog').innerHTML = '<p>Erro ao carregar produtos. Verifique as Políticas RLS no Supabase.</p>';
                return;
            }

            const grid = document.getElementById('public-catalog');
            grid.innerHTML = products.length ? products.map(p => `
                <div class="card">
                    <img src="${p.imagem_url || 'https://placehold.co/400x300?text=Produto'}" alt="${p.nome}">
                    <div style="margin-bottom:0.5rem; font-size:0.8rem; color:#64748b;">${p.stores.nome_loja} • ${p.stores.cidade}</div>
                    <h4>${p.nome}</h4>
                    <p style="font-size:1.2rem; font-weight:bold; color:var(--primary); margin:0.5rem 0;">R$ ${p.preco}</p>
                    <button class="btn btn-primary" style="width:100%" onclick="buyProduct('${p.id}')">Ver Detalhes</button>
                </div>
            `).join('') : '<p>Nenhuma oferta disponível no momento.</p>';
        }

        function buyProduct(id) {
            if (!currentUser) {
                alert('Faça login para comprar ou solicitar serviços.');
                openAuthModal();
            } else {
                // Lógica de compra (simplificada, redireciona para dashboard)
                alert('Redirecionando para área de pedidos...');
                loadDashboard();
            }
        }

        function updateHeader(isLogged) {
            const nav = document.getElementById('nav-actions');
            if (isLogged) {
                nav.innerHTML = `
                    <button class="btn btn-outline" onclick="loadDashboard()">Meu Painel</button>
                    <button class="btn btn-outline" onclick="logout()">Sair</button>
                `;
            } else {
                nav.innerHTML = `<button class="btn btn-primary" onclick="openAuthModal()">Entrar / Cadastrar</button>`;
            }
        }

        // --- 5. SISTEMA DE CADASTRO INTELIGENTE ---
        
        function openAuthModal() { document.getElementById('auth-modal').style.display = 'flex'; }
        function closeAuthModal() { document.getElementById('auth-modal').style.display = 'none'; backToLogin(); }
        
        function backToLogin() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('role-selection').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('auth-title').innerText = "Acessar Conta";
        }

        function showRoleSelection() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('role-selection').classList.remove('hidden');
            document.getElementById('auth-title').innerText = "Criar Conta";
        }

        function selectRole(role) {
            selectedRole = role;
            document.getElementById('role-selection').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            
            const container = document.getElementById('dynamic-fields');
            container.innerHTML = ''; // Limpa campos anteriores

            // Título
            const titles = { 'cliente': 'Cliente', 'loja_admin': 'Administrador de Loja', 'motorista': 'Motorista Parceiro', 'montador': 'Montador Parceiro' };
            document.getElementById('reg-role-title').innerText = `Cadastro de ${titles[role]}`;

            // GERAÇÃO DOS CAMPOS DINÂMICOS
            let html = '';

            if (role === 'loja_admin') {
                html += `<label>Nome da Loja</label><input type="text" id="reg-store-name">`;
                html += `<label>CNPJ</label><input type="text" id="reg-cnpj" placeholder="00.000.000/0000-00">`;
            } 
            else if (role === 'motorista') {
                html += `<label>Nome Completo</label><input type="text" id="reg-name">`;
                html += `<label>CPF</label><input type="text" id="reg-cpf">`;
                
                // Simulação de Upload
                html += `<label>Foto da Habilitação (Frente e Verso)</label>
                         <input type="file" id="reg-cnh" multiple style="border:1px dashed #ccc;">`;
                
                // Simulação de Verificação Facial
                html += `<div style="margin-top:1rem; border:1px solid #ddd; padding:1rem; border-radius:8px;">
                            <label style="color:var(--primary)">Verificação de Segurança (Capacete/EPI)</label>
                            <p style="font-size:0.8rem; margin-bottom:0.5rem">Precisamos verificar se você possui os equipamentos.</p>
                            <video id="camera-preview" autoplay playsinline></video>
                            <div id="verification-status" class="verified-badge"><i class="ri-checkbox-circle-fill"></i> Verificado com IA</div>
                            <button class="btn btn-outline" id="btn-camera" style="width:100%; margin-top:0.5rem" onclick="startCameraSim()">
                                <i class="ri-camera-fill"></i> Tirar Foto de Verificação
                            </button>
                         </div>`;
            } 
            else {
                // Cliente e Montador
                html += `<label>Nome Completo</label><input type="text" id="reg-name">`;
                html += `<label>CPF</label><input type="text" id="reg-cpf">`;
            }

            container.innerHTML = html;
        }

        // Simula a câmera e verificação
        async function startCameraSim() {
            const video = document.getElementById('camera-preview');
            const btn = document.getElementById('btn-camera');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.style.display = 'block';
                btn.innerText = "Analisando...";
                
                // Simula tempo de processamento da IA
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop()); // Para a camera
                    video.style.display = 'none';
                    document.getElementById('verification-status').style.display = 'flex';
                    btn.style.display = 'none';
                    alert('Verificação Facial Concluída! Equipamentos detectados.');
                }, 3000);
            } catch (e) {
                alert('Não foi possível abrir a câmera. Verifique as permissões.');
            }
        }

        // --- 6. REGISTRO E LOGIN ---
        async function registerUser() {
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-pass').value;
            const metaData = { role: selectedRole };

            // Captura dados extras
            if(document.getElementById('reg-name')) metaData.full_name = document.getElementById('reg-name').value;
            if(document.getElementById('reg-cpf')) metaData.cpf = document.getElementById('reg-cpf').value;
            if(document.getElementById('reg-cnpj')) metaData.cnpj = document.getElementById('reg-cnpj').value;
            if(document.getElementById('reg-store-name')) metaData.store_name = document.getElementById('reg-store-name').value;

            try {
                // 1. Cria User no Auth
                const { data, error } = await supabase.auth.signUp({
                    email, password,
                    options: { data: metaData } // Salva no user_metadata temporariamente
                });
                
                if (error) throw error;

                // 2. Se for loja, cria a entrada na tabela stores
                if (selectedRole === 'loja_admin' && data.user) {
                    await supabase.from('stores').insert({
                        admin_id: data.user.id,
                        nome_loja: metaData.store_name,
                        cnpj: metaData.cnpj
                    });
                }
                
                // 3. Se for motorista, update perfil com dados "fakes" de verificação
                if (selectedRole === 'motorista' && data.user) {
                    // Aqui você faria o upload real da imagem para o Supabase Storage
                    await supabase.from('profiles').update({
                        cpf: metaData.cpf,
                        is_verified: true // Assumindo que a verificação de câmera passou
                    }).eq('id', data.user.id);
                }

                alert('Cadastro realizado com sucesso! Faça login.');
                backToLogin();

            } catch (err) {
                alert('Erro no cadastro: ' + err.message);
            }
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;
            
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) alert(error.message);
            else {
                closeAuthModal();
                window.location.reload(); // Recarrega para atualizar estado
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.reload();
        }

        // --- 7. DASHBOARD LOGIC (Simplificado para caber no exemplo) ---
        async function loadDashboard() {
            document.getElementById('home-section').classList.remove('active');
            document.getElementById('dashboard-section').classList.add('active');
            
            // Reutilizando lógica do script anterior, mas adaptada
            const content = document.getElementById('dashboard-content');
            
            // Busca perfil atualizado
            const { data: profile } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();

            content.innerHTML = `
                <h2>Painel de Controle - ${profile.role.toUpperCase()}</h2>
                <p>Bem-vindo, ${profile.nome_completo || profile.email}</p>
                <div class="card" style="margin-top:2rem">
                    <h3>Status da Conta</h3>
                    <p>Verificado: ${profile.is_verified ? '<span style="color:green">SIM</span>' : 'Não/Pendente'}</p>
                    ${profile.role === 'loja_admin' ? `<p>CNPJ: ${profile.cnpj || 'Não informado'}</p>` : ''}
                    ${profile.role === 'motorista' ? `<p>Habilitação: Enviada</p>` : ''}
                </div>
                <button class="btn btn-outline" onclick="window.location.reload()" style="margin-top:1rem">Voltar para Home</button>
            `;
        }

        // Inicia App
        init();

    </script>
</body>
</html>
